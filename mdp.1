.\"
.\" Copyright (c) 2012-2014 Bertrand Janin <b@janin.com>
.\" 
.\" Permission to use, copy, modify, and distribute this software for any
.\" purpose with or without fee is hereby granted, provided that the above
.\" copyright notice and this permission notice appear in all copies.
.\" 
.\" THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
.\" WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
.\" MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
.\" ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
.\" WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
.\" ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
.\" OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
.\"
.Dd $Mdocdate: January 24 2014 $
.Dt MDP 1
.Os
.Sh NAME
.Nm mdp
.Nd minimalist password safe
.\" SYNOPSIS
.Sh SYNOPSIS
.Nm mdp
.Bk -words
.Op Fl Vh
.Op Fl c Ar config
.Ar command
.Op Ar arguments ...
.Ek
.\" DESCRIPTION
.Sh DESCRIPTION
.Nm
wraps GnuPG, your favorite editor, a password generator and a custom temporary
full-screen pager to let you manage your password library.
.Pp
Naturally edit your password file (create, sort, delete) with your editor, rely
on GnuPG to do the right thing for crypto and let
.Nm
do the rest. In order to avoid passwords to linger on your screen, results
from your queries are displayed through a custom pager that gets cleared after
a customizable timeout (default 10 seconds).
.Pp
The following options are global and apply to all the subsequent commands:
.Bl -tag -width Ds
.It Fl c Ar config
Use an alternate configuration file.
.It Fl V
Print version.
.It Fl h
Print general usage. If you wish to get the usage for a specic command, you can
place this flag after the command name. For example 'mdp edit -h'.
.El
.\" COMMANDS
.Sh COMMANDS
.\" mdp add
.Nm mdp
.Bk -words
.Ar add
.Op Fl h
.Op Fl k Ar keyid
.Op Fl p Ar profile
.Op Fl n Ar count
.Op Fl l Ar length
.Ar keywords ...
.Ek
.Bd -ragged -offset indent
Add passwords to the end of your password file. This command is essentially a
blend of 'generate' and 'edit' with the added advantage that it avoids
copy-paste. All the arguments to this command will be used as prefix in your
password file (with the exception of the options starting with '-').
.Pp
The options for the 'add' command are the same as the 'edit' and the 'generate'
command.
.Ed
.\" mdp edit
.Pp
.Nm mdp
.Bk -words
.Ar edit
.Op Fl h
.Op Fl k Ar keyid
.Ek
.Bd -ragged -offset indent
Edit your password file (decrypt and re-encrypt after the fact). This command
creates a temporary file in mdp's configuration folder and starts your editor
on it, the file is fed to GnuPG when your editor quits and if the file has
changed in any way.
.Pp
The only option for the 'edit' command is:
.Bl -tag -width Ds
.It Fl k Ar key_id
The argument is a GnuPG key id (8 alpha-numeric characters), it could be used
to specify your key id in case you did not define it in your configuration
file.
.El
.Ed
.\" mdp generate
.Pp
.Nm mdp
.Bk -words
.Ar generate
.Op Fl h
.Op Fl p Ar profile
.Op Fl n Ar count
.Op Fl l Ar length
.Ek
.Bd -ragged -offset indent
Generate password(s) according to your configuration or command-line arguments.
Without profile specified, this will use the top-level definitions for the character
set, password length and count (see CONFIGURATION below). All the flags
specified on the command-line will override the ones specified in the profile
or top-level definitions. You can call this command with the 'gen' shortcut.
.Pp
The options for the generate command are:
.Bl -tag -width Ds
.It Fl p Ar profile
Choose which profile to use among the ones defined in your configuration file.
.It Fl n Ar count
Number of passwords to generate. This command line parameter will override all
other values of password_count (global and profile).
.It Fl l Ar length
Length of generated passwords (in bytes). This command line parameter will
override all other values of password_count (global and profile).
.El
.Ed
.\" mdp get
.Pp
.Nm mdp
.Bk -words
.Ar get
.Op Fl hEr
.Ar keywords ...
.Ek
.Bd -ragged -offset indent
Return all the password entries matching the given keywords or regexs (if using
-E). By default, this command will open a full-screen pager to display the result
of your search, the time the pager remains on screen is adjustable in the
configuration file. Note that you can hit '/' on the result screen to start
another search.
.Pp
The options for the get command are:
.Bl -tag -width Ds
.It Fl E
Use regexes instead of plain text matches (e.g. ^.mail).
.It Fl r
Displays the result without pager, plain terminal dump to stdout. This option
should be used sparingly since the password will linger on screen and in your
terminal buffer/history.
.El
.Ed
.\" mdp prompt
.Pp
.Nm mdp
.Bk -words
.Ar prompt
.Op Fl h
.Ek
.Bd -ragged -offset indent -compact
Enter a full-screen pager/search prompt system. This command is useful to avoid
passing the search keywords in the command line (and allowing all users in the
system to see what passwords you are requesting). Secondly, since this uses the
default pager, you can run multiple search using the '/' key. Any other key will
exit the pager, it will also exit after a configurable timer.
.Ed
.\" QUICK WALKTHROUGH
.Sh QUICK WALKTHROUGH
.Bl -tag -width Ds
.It 1. Create your GPG key if you don't already have one.
.It 2. Setup your EDITOR variable if it's not already done.
.It 3. Create a .mdp/config file from the example (at least gpg_key_id).
.It 4. Pick a password from randomly generated ones, for example:
.Bd -literal -offset indent
mdp gen
.Ed
.It 5. Run "mdp edit" and add a line such as:
.Bd -literal -offset indent
twitter sponge@bob.com yHVHPnqXyx6qUuki
.Ed
.It 6. Now when you need your Twitter password, you can just type:
.Bd -literal -offset indent
mdp get twitter
.Ed
.El
.\" CONFIGURATION
.Sh CONFIGURATION
This is an alphabetically sorted summary of all the available configuration
variables and options:
.Bl -tag -width Ds
.It Ic set backup Ar no
Define whether we keep a backup every time we edit the password file. Default:
yes.
.Pp
.It Ic set character_count Ar count
Define how many characters to randomize per password. Default: 16 or as defined
in the profile.
.Pp
.It Ic set character_set Ar characters
Define all the characters to use in your passwords. Default: all alphanumeric
(upper and lower case) or as define in the profile. The following aliases are
supported as shortcuts: $LOWERCASE, $UPPERCASE, $ALPHA, $DIGITS, $ALPHANUMERIC,
$SYMBOLS, $PRINTABLE.
.Pp
.It Ic set editor Ar path
Path to your favorite editor. You typically don't need to set this variable
since
.Nm
will use your default editor (as defined by $EDITOR). If
.Nm
detects vim, it will attempt to add the -n parameter to avoid vim from creating
swap files.
.Pp
.It Ic set gpg_key_id Ar key_id
GnuPG key id (default: none). If no key is selected,
.Nm
will expect you to specify it on the command-line (-k). If no key was specified
either way,
.Nm
will abort. That this parameter is ignored during the decryption phase, GnuPG
picks the key based on the content of the password file.
.Pp
.It Xo Ic set gpg_path Ar path
.Xc
GnuPG absolute path (default: /usr/bin/gpg)
.Pp
.It Ic set gpg_timeout Ar seconds
Number of seconds to give GnuPG for password and pipe interaction. The
default value is 10 seconds. This will kill GnuPG if forgotten at the password
prompt or if it cannot communicate with the parent process.
.Pp
.It Ic set password_count Ar count
Define how many password to show with using 'mdp gen'. Default: 4 or as defined
in the profile.
.Pp
.It Ic set password_file Ar filepath
Sets the location of the password file. mdp will refuse to use a password file
with permissions other than 0600. The default value for this is
~/.mdp/passwords.
.Pp
.It Ic set timeout Ar seconds
This variable define how long the pager will display your passwords. The
default value is 10 seconds.
.Nm
will use your default editor (as defined by $EDITOR). 
.It Ic profile Ar name
All the variables define below a profile header will be specific to this
profile. For now only password_count, character_count and character_set are
valid options.
.El
.\" PASSWORD FILE
.Sh PASSWORD FILE
Your password file should be structured to make it convenient for mdp to query
it. Since mdp queries work similarly to grep, you want to use a line-based
system with one line per password. The simplest line format is:
.Bd -literal -offset indent
nameOfServiceA   password1
anotherService   password2
.Ed
.Pp
You can separate your name/notes and your password with spaces, tabs or any
character except new-line (\\n). This format allows you to find the services by name, e.g.:
.Bd -literal -offset indent
mdp serviceA
.Ed
.Pp
You can use any number of namespacing hints if you need more structure, the
following allow you to fetch all your email passwords at once:
.Bd -literal -offset indent
email     serviceA       password1
email     serviceB       password2
irc       serviceC       password3
.Ed
.Pp
You can use '#' in the beginning of a line to avoid mdp from displaying a
password. This is particularly useful to add meta data to your password file or
keep track of previous password without adding noise to the output. For example:
.Bd -literal -offset indent
# email services
serviceA     password1
serviceB     password2

# irc servers
serviceC     password3
.Ed
.Pp
Empty lines are naturally ignored.
.Sh FAQ
.Bl -tag -width Ds
.It Why not 'shred' the temporary file?
If you are afraid of getting your disk stolen, encrypt it. Shred has limited
use on most journaled file-systems.
.It What if I don't trust 'root'?
You're screwed, you can't trust this machine with your valuable information.
.It What if my server is virtualized?
Same answer as above, if you don't trust your hosting provider or IaaS, good
luck.
.El
.\" ENVIRONMENT
.Sh ENVIRONMENT
.Bl -tag
.It Ev EDITOR
The content of this variable will be used as default editor if the
configuration does not alter it.
.El
.\" FILES
.Sh FILES
.Bl -tag
.It Pa $HOME/.mdp/config
Main configuration file for
.Nm .
You need at least your gpg_key_id in there, without it you will be required to
specify it every single time.
.It Pa $HOME/.mdp/passwords
Encrypted list of passwords.
.It Pa $HOME/.mdp/passwords.bak
This file is a copy of your password file, before the last edit. You can revert
to the last file by simply replacing your password file. Creation of this file
can be disabled (see "set backup").
.It Pa $HOME/.mdp/lock
This file is created while you edit your password list to avoid two copies
of mdp to run at the same time for the same user.
.El
.\" SEE ALSO
.Sh SEE ALSO
.Xr gpg 1 ,
.Xr sh 1
.\" BUGS
.Sh BUGS
.Bl -tag -width Ds
.It - None that we know of.
.El
.\" AUTHORS
.Sh AUTHORS
mdp was written by Bertrand Janin <b@janin.com> and is distributed under an ISC
license (BSD, MIT and OSI compatible).
.Pp
A bunch of utility functions are borrowed from OpenBSD and OpenSSH, both
under ISC and BSD licenses, with copyrights from the following authors:
.Pp
    Copyright (c) 2004 Ted Unangst and Todd Miller
    Copyright (c) 1998 Todd C. Miller <Todd.Miller@courtesan.com>
    Copyright (c) 2000 Markus Friedl.  All rights reserved.
    Copyright (c) 2005,2006 Damien Miller.  All rights reserved.
.Pp
The random password generator was mostly borrowed from apg (also BSD
licensed), with the following copyright notice:
.Pp
    Copyright (c) 1999, 2000, 2001, 2002, 2003
    Adel I. Mirzazhanov. All rights reserved
.Pp
The array and xmalloc libraries are taken from tmux, with the following
copyright notices:
.Pp
    Copyright (c) 2004 Nicholas Marriott <nicm@users.sourceforge.net>
    Copyright (c) 2006 Nicholas Marriott <nicm@users.sourceforge.net>
