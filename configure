#!/bin/sh
#
# Configure script for 'mdp'
# Copyright (c) 2012-2015 Bertrand Janin <b@janin.com>
#
#

PROG="mdp"
MDP_VERSION="0.8.0"


# Some shells have shitty echos
alias echo=/bin/echo


# generate_makefile() - Generate the main Makefile
# $1 - source makefile, appended at the end
generate_makefile() {
	echo "# Automagically generated by 'configure'"
	echo

	echo "PROG=$PROG"
	echo "CFLAGS+=$CFLAGS -std=c99 -pedantic"
	echo "CFLAGS+=-Wall -W -Wpointer-arith -Wbad-function-cast -Wcast-qual"
	echo "CFLAGS+=-Wstrict-prototypes -Wmissing-prototypes"
	echo "CFLAGS+=-Wmissing-declarations -Wnested-externs -Winline"
	echo "CFLAGS+=-DMDP_VERSION=\\\"$MDP_VERSION\\\" $X_CFLAGS"

	if [ "$DEBUG_MODE" = "Y" ]; then
		echo "CFLAGS+=-ggdb -O0"
	else
		echo "CFLAGS+=-O2"
	fi

	if [ -n "$X_OBJECTS" ]; then
		echo "EXTRA_OBJECTS=$X_OBJECTS"
	fi

	echo "CC?=$CC"
	echo "PREFIX?=$PREFIX"
	echo "MANDEST=$MANDEST"
	echo "CURSESLIB=$CURSESLIB"

	cat "$1"
}


# usage() - Spit out basic help
usage() {
	echo "usage: ./configure [-hd] [--prefix path] [platform]"
	echo
	echo "    -h              this help screen."
	echo "    -d              configure for debug mode (-ggdb -O0)"
	echo "    --prefix path   base path for installation"
	echo
	exit
}


# stuff_not_found() - Exit 'cause we're missing something
stuff_not_found() {
	message="$1"
	echo "not found"
	echo
	echo ERROR: $message
	exit 2
}


# Command-line arguments
while true; do
	case "$1" in
		-h|--help)
			usage
			exit 2
			;;

		-d|--debug)
			echo "Debug mode... enabled"
			DEBUG_MODE="Y"
			shift
			;;

		--prefix=*)
			PREFIX="${1##--prefix=}"
			shift
			;;

		# Skip all random long opts passed by packagers thinking this
		# is autoconf-compatible.
		--*)
			shift
			;;

		*)
			break
			;;
	esac
done


# Detect platform
echo -n "Target platform... "
OS=`uname`
if [ -n "$1" ]; then
	OS="$1"
fi
echo $OS


# Platform-specific configuration
case $OS in
	Linux|Unix|POSIX)
		X_CFLAGS="-D_GNU_SOURCE"
		X_OBJECTS="arc4random.o"
		MANDEST="share/man"
		;;

	NetBSD)
		CURSESLIB="-lcurses"
		;;

	Darwin)
		MANDEST="share/man"
		CURSESLIB="-lncurses"
		;;
esac


# Default paths
[ -z "$CURSESLIB" ]	&& CURSESLIB="-lncursesw"
[ -z "$PREFIX" ]	&& PREFIX="/usr/local"
[ -z "$MANDEST" ]	&& MANDEST="man"


# Check for make
echo -n "make... "
cat <<EOF > fake_makefile
all:
	@echo found
EOF
if ! make -f fake_makefile 1>/dev/null 2>/dev/null; then
	stuff_not_found "Make not found (try to install make or gmake)"
fi
echo found
rm -f fake_makefile*


# Check if we have a working cc
if [ -z "$CC" ]; then
	if cc -v 1>/dev/null 2>/dev/null; then
		export CC=cc
	elif gcc -v 1>/dev/null 2>/dev/null; then
		export CC=gcc
	else
		stuff_not_found "No C compiler found (try to install clang or gcc)"
	fi
fi

echo -n "cc... "
cat <<EOF > fake_cc.c
#include <stdio.h>
main() { printf("woot\n"); }
EOF
if ! ${CC} fake_cc.c -o /dev/null 1>/dev/null 2>/dev/null; then
	stuff_not_found "Detected compiler (${CC}) is not working"
fi
echo ${CC}
rm -f fake_cc*


# Check if we have strlcpy
echo -n "strlcpy... "
cat <<EOF > fake_strlcpy.c
main() { char buf[32]; strlcpy(buf, "woot", sizeof(buf)); }
EOF
if ! ${CC} fake_strlcpy.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS strlcpy.o"
	CFLAGS="$CFLAGS -DHAS_NO_STRLCPY"
else
	echo yes
fi
rm -f fake_strlcpy*


# Check if we have strlcat
echo -n "strlcat... "
cat <<EOF > fake_strlcat.c
main() { char buf[32]; buf[0] = '\0'; strlcat(buf, "woot", sizeof(buf)); }
EOF
if ! ${CC} fake_strlcat.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS strlcat.o"
	CFLAGS="$CFLAGS -DHAS_NO_STRLCAT"
else
	echo yes
fi
rm -f fake_strlcat*


# Check if we have statfs.f_iosize
echo -n "statfs.f_iosize... "
cat <<EOF > fake_statfs_f_iosize.c
#include <sys/param.h>
#include <sys/mount.h>
main() { struct statfs fsb; int x = fsb.f_iosize; }
EOF
if ! ${CC} fake_statfs_f_iosize.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use a default buffer size)"
	CFLAGS="$CFLAGS -DHAS_NO_F_IOSIZE"
else
	echo yes
fi
rm -f fake_statfs_f_iosize*


# Check if we have wcslcpy
echo -n "wcslcpy... "
cat <<EOF > fake_wcslcpy.c
#include <wchar.h>
main() { wchar_t buf[32]; wcslcpy(buf, L"woot", sizeof(buf)); }
EOF
if ! ${CC} fake_wcslcpy.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS wcslcpy.o"
	CFLAGS="$CFLAGS -DHAS_NO_WCSLCPY"
else
	echo yes
fi
rm -f fake_wcslcpy*


# Check if we have explicit_bzero
echo -n "explicit_bzero... "
cat <<EOF > fake_explicit_bzero.c
#include <string.h>
#include <stdlib.h>
main() { char *buf; buf = malloc(128); explicit_bzero(buf, 128); }
EOF
if ! ${CC} fake_explicit_bzero.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS explicit_bzero.o"
	CFLAGS="$CFLAGS -DHAS_NO_EXPLICIT_BZERO"
else
	echo yes
fi
rm -f fake_explicit_bzero*


# Check for curses
echo -n "curses... "
cat <<EOF > fake_curses.c
#include <curses.h>
main() { initscr(); }
EOF
if ! ${CC} fake_curses.c -o /dev/null ${CURSESLIB} 1>/dev/null 2>/dev/null; then
	stuff_not_found "Can't compile with curses (missing headers or library)"
fi
echo "found (${CURSESLIB})"
rm -f fake_curses*

echo
find . -name "Makefile.src" | while read input; do
	output=${input%%.src}
	echo "generating $output"
	generate_makefile $input > $output
done

echo
echo "Run 'make' (or 'gmake') to compile and 'sudo make install' to install."
